<!-- comment_form.html -->
<form 
    id="commentForm"
    method="post"
    enctype="multipart/form-data" 
    hx-post="{% url 'create_comment' %}"
    hx-target="#commentsContainer"
    hx-swap="afterbegin"
    hx-encoding="multipart/form-data"
    hx-on::after-request="
        if(event.detail.xhr.status === 200 && event.detail.requestConfig.verb === 'post') {
            this.reset();
            resetCommentForm();
        }
    "
    class="bg-surface rounded-lg transition-shadow duration-200"
>
    {% csrf_token %}
    
    <div class="p-3">
        <!-- Contenedor RELATIVO para el textarea y dropdown -->
        <div class="relative">
            <textarea 
                name="content" 
                id="commentTextarea"
                rows="5"
                class="w-full bg-transparent rounded p-2 text-text placeholder:text-muted resize-none focus:outline-none text-lg overflow-hidden" 
                placeholder="¿Qué estás pensando? Usa @ para mencionar"
                oninput="autoResize(this)"
                required
            ></textarea>
            
            <!-- Dropdown de menciones -->
            <div id="mentionsDropdown" 
                 class="hidden absolute left-0 bottom-full mb-2 w-80 max-w-full bg-surface border border-muted/30 rounded-lg shadow-2xl overflow-hidden z-50">
                <div class="px-3 py-2 bg-surface-dark border-b border-muted/20">
                    <p class="text-xs text-muted flex items-center gap-1.5">
                        <i class="fas fa-at text-primary"></i>
                        <span>Mencionar usuario</span>
                    </p>
                </div>
                
                <ul id="mentionsList" class="max-h-64 overflow-y-auto mentions-scrollbar"></ul>
                
                <div id="mentionsLoading" class="hidden px-4 py-3 text-center text-sm text-muted">
                    <i class="fas fa-spinner fa-spin"></i> Buscando...
                </div>
            </div>
        </div>
        
        <!-- Preview de imagen -->
        <div id="imagePreviewContainer" class="hidden mt-3 relative group w-fit">
            <img id="imagePreview" src="" alt="Preview" class="max-h-48 rounded-lg border border-muted object-cover">
            <button type="button" 
                    onclick="removeImage()" 
                    class="absolute top-1 right-1 bg-black/50 hover:bg-black/70 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center transition-colors">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
    </div>

    <!-- Barra de acciones -->
    <div class="flex items-center w-full justify-between px-3 py-2 border-t border-muted/20">
        <div class="flex items-center text-primary gap-2">
            <input type="file" 
                   name="image" 
                   id="imageInput" 
                   accept="image/*" 
                   class="hidden cursor-pointer" 
                   onchange="handleFileSelect(this)">
            
            <button type="button" 
                    onclick="document.getElementById('imageInput').click()" 
                    class="cursor-pointer p-2 rounded-full hover:bg-primary/10 transition-colors" 
                    title="Añadir imagen">
                <i class="far fa-image text-lg"></i>
            </button>
        </div>

        <button type="submit" 
                class="cursor-pointer bg-primary text-background px-4 py-1.5 rounded-full font-medium hover:bg-primary/10 hover:text-white transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
            Publicar
        </button>
    </div>

    <div id="commentErrorContainer" class="px-4 pb-2 text-danger text-sm"></div>
</form>

<script>
    // ==================== AUTO-RESIZE ====================
    if (typeof autoResize !== 'function') {
        window.autoResize = function(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            if(textarea.value === '') textarea.style.height = 'auto';
        };
    }

    // ==================== IMÁGENES ====================
    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Validar tamaño (máx 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('La imagen es demasiado grande. El tamaño máximo es 5MB.');
                input.value = '';
                return;
            }
            
            // Validar tipo
            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona un archivo de imagen válido.');
                input.value = '';
                return;
            }
            
            showPreview(file);
        }
    }

    // Pegar imágenes desde el portapapeles
    document.getElementById('commentTextarea').addEventListener('paste', function(e) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let index in items) {
            const item = items[index];
            if (item.kind === 'file' && item.type.includes('image/')) {
                const blob = item.getAsFile();
                
                // Validar tamaño
                if (blob.size > 5 * 1024 * 1024) {
                    alert('La imagen es demasiado grande. El tamaño máximo es 5MB.');
                    return;
                }
                
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(blob);
                document.getElementById('imageInput').files = dataTransfer.files;
                showPreview(blob);
                e.preventDefault();
                break;
            }
        }
    });

    function showPreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('imagePreviewContainer').classList.remove('hidden');
        }
        reader.onerror = function() {
            alert('Error al cargar la imagen. Por favor intenta de nuevo.');
        }
        reader.readAsDataURL(file);
    }

    function removeImage() {
        document.getElementById('imageInput').value = '';
        document.getElementById('imagePreview').src = '';
        document.getElementById('imagePreviewContainer').classList.add('hidden');
    }

    function resetCommentForm() {
        const textarea = document.getElementById('commentTextarea');
        if (textarea) {
            textarea.style.height = 'auto';
        }
        removeImage();
    }

    // ==================== SISTEMA DE MENCIONES ====================
    // Inicializar después de cargar el script mentions-system.js
    function initMainCommentMentions() {
        if (typeof MentionSystem !== 'undefined') {
            const searchUrl = "{% url 'search_users_mention' %}";
            window.mainCommentMentionSystem = new MentionSystem('commentTextarea', searchUrl);
        } else {
            console.error('❌ MentionSystem no está disponible. Asegúrate de cargar mentions-system.js primero.');
        }
    }
    
    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMainCommentMentions);
    } else {
        initMainCommentMentions();
    }
</script>