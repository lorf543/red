{% extends "base.html" %}
{% load static %}

{% block content %}

<section class="flex min-h-screen bg-background">
    <div class="flex w-full" x-data="{ currentTab: 'estilos' }">
        
        <!-- Sidebar Desktop -->
        <div class="hidden md:flex md:w-64 bg-surface border-r border-gray-200 flex-col">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-text">Configuración</h2>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1 px-3">
                    <li>
                        <a href="#"
                           @click.prevent="currentTab = 'estilos'"
                           :class="currentTab === 'estilos' ? 'text-indigo-700 bg-indigo-50 border-l-4 border-indigo-700' : 'text-gray-600 hover:bg-gray-50 border-l-4 border-transparent'"
                           class="flex items-center px-4 py-3 rounded-r-lg transition-all duration-200">
                            <i class="fas fa-paint-brush w-5 text-center"></i>
                            <span class="ml-3 font-medium">Estilos</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

                <!-- Header -->
                <div class="mb-8">
                    <div class="bg-surface rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-start justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-text mb-2">Configuración de Estilos</h1>
                                <p class="text-text text-sm">
                                    Personaliza la apariencia de tu perfil con fondos y cursores personalizados.
                                </p>
                            <p class="text-sm font-semibold text-muted">esta pagina aun esta en construcion pueden esperar cosas raras :V</p>

                            </div>
                            <div class="hidden sm:flex items-center justify-center w-12 h-12 bg-indigo-100 rounded-lg">
                                <i class="fas fa-paint-brush text-indigo-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB Estilos -->
                <div x-show="currentTab === 'estilos'" 
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 transform scale-95"
                     x-transition:enter-end="opacity-100 transform scale-100">
                    {% include 'conf/partials/backgroun_cursor.html' %}
                </div>

            </div>
        </div>
    </div>
</section>

<!-- JS -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    /* ---------- BACKGROUND PREVIEW ---------- */
    const bgInput = document.getElementById("background_url");
    const bgContainer = document.getElementById("background_container");

    if (bgInput && bgContainer) {
        function hideBg() {
            bgContainer.innerHTML = `
                <div class="text-center text-gray-400">
                    <i class="fas fa-image text-4xl mb-2"></i>
                    <p class="text-sm">Ingresa una URL para ver la vista previa</p>
                </div>
            `;
            bgContainer.style.backgroundImage = "";
        }

        function showBg(url) {
            bgContainer.style.backgroundImage = `url("${url}")`;
            bgContainer.style.backgroundSize = "cover";
            bgContainer.style.backgroundPosition = "center";
            bgContainer.innerHTML = "";
        }

        function updateBg() {
            const url = bgInput.value.trim();
            if (!url) return hideBg();

            const img = new Image();
            img.src = url;
            img.onload = () => showBg(url);
            img.onerror = () => {
                hideBg();
                console.log("Error cargando imagen de fondo");
            };
        }

        bgInput.addEventListener("input", updateBg);
        setTimeout(updateBg, 100);
    }

    /* ---------- CURSOR PREVIEW MEJORADO (MULTI-CURSOR) ---------- */

    const hotspotXInput = document.getElementById("id_cursor_hotspot_x");
    const hotspotYInput = document.getElementById("id_cursor_hotspot_y");
    const cursorBoxes = document.querySelectorAll(".cursor-box");
    const globalCursorCoords = document.getElementById("global_cursor_coords");

    // Mapeo de inputs de cursores
    const cursorInputs = {
        'default': document.getElementById("id_cursor_url"),
        'pointer': document.getElementById("id_cursor_pointer_url"),
        'text': document.getElementById("id_cursor_text_url"),
        'not-allowed': document.getElementById("id_cursor_blocked_url")
    };

    // Función para actualizar preview individual
    function updateIndividualPreview(input) {
        if (!input) return;
        
        const url = input.value.trim();
        const previewBox = input.parentElement.querySelector('.cursor-preview-box');
        const previewImg = previewBox?.querySelector('.cursor-preview-img');
        const previewSize = previewBox?.querySelector('.cursor-preview-size');

        if (!url) {
            previewBox?.classList.add('hidden');
            return;
        }

        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = url;

        img.onload = () => {
            if (previewImg && previewSize && previewBox) {
                previewImg.src = url;
                previewSize.textContent = `${img.width}x${img.height}px`;
                previewBox.classList.remove('hidden');
            }
        };

        img.onerror = () => {
            previewBox?.classList.add('hidden');
        };
    }

    // Función para actualizar todos los cursores en el área de prueba
    function updateAllCursors() {
        const x = parseInt(hotspotXInput.value) || 0;
        const y = parseInt(hotspotYInput.value) || 0;

        cursorBoxes.forEach(box => {
            const cursorType = box.dataset.cursor;
            const input = cursorInputs[cursorType];
            
            if (input && input.value.trim()) {
                const url = input.value.trim();
                box.style.cursor = `url("${url}") ${x} ${y}, ${cursorType}`;
            } else {
                box.style.cursor = cursorType;
            }
        });
    }

    // Event listeners para cada cursor
    Object.values(cursorInputs).forEach(input => {
        if (input) {
            input.addEventListener("input", () => {
                updateIndividualPreview(input);
                updateAllCursors();
            });
            // Inicializar preview
            setTimeout(() => updateIndividualPreview(input), 100);
        }
    });

    // Event listeners para hotspots
    if (hotspotXInput) {
        hotspotXInput.addEventListener("input", updateAllCursors);
    }

    if (hotspotYInput) {
        hotspotYInput.addEventListener("input", updateAllCursors);
    }

    // Mostrar coordenadas del mouse
    if (globalCursorCoords) {
        document.getElementById("cursor_test_area")?.addEventListener("mousemove", (e) => {
            const rect = e.target.getBoundingClientRect();
            const x = Math.round(e.clientX - rect.left);
            const y = Math.round(e.clientY - rect.top);
            globalCursorCoords.textContent = `X: ${x}, Y: ${y}`;
        });
    }

    // Inicializar cursores
    setTimeout(updateAllCursors, 100);

    /* ---------- HELPER FUNCTIONS ---------- */
    
    window.setHotspot = function(x, y) {
        hotspotXInput.value = x;
        hotspotYInput.value = y;
        updateAllCursors();
    };

    window.detectCursorCenter = function() {
        // Detectar desde el primer cursor que tenga URL
        let targetInput = null;
        for (const input of Object.values(cursorInputs)) {
            if (input && input.value.trim()) {
                targetInput = input;
                break;
            }
        }

        if (!targetInput) {
            showNotification("Primero ingresa al menos una URL de cursor", "warning");
            return;
        }

        const url = targetInput.value.trim();
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = url;
        
        img.onload = () => {
            const centerX = Math.floor(img.width / 2);
            const centerY = Math.floor(img.height / 2);
            setHotspot(centerX, centerY);
            showNotification(`Centro detectado: ${centerX}, ${centerY}`, "success");
        };
        
        img.onerror = () => {
            showNotification("No se pudo cargar la imagen del cursor", "error");
        };
    };

    window.resetAllCursors = function() {
        if (confirm("¿Estás seguro de que deseas resetear todos los cursores?")) {
            Object.values(cursorInputs).forEach(input => {
                if (input) input.value = "";
            });
            hotspotXInput.value = "0";
            hotspotYInput.value = "0";
            
            // Actualizar previews
            Object.values(cursorInputs).forEach(input => {
                if (input) updateIndividualPreview(input);
            });
            updateAllCursors();
            
            showNotification("Todos los cursores han sido reseteados", "success");
        }
    };

    // Sistema de notificaciones
    function showNotification(message, type = "info") {
        const colors = {
            success: "bg-green-500",
            error: "bg-red-500",
            warning: "bg-yellow-500",
            info: "bg-blue-500"
        };

        const icons = {
            success: "fa-check-circle",
            error: "fa-exclamation-circle",
            warning: "fa-exclamation-triangle",
            info: "fa-info-circle"
        };

        const msg = document.createElement("div");
        msg.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2`;
        msg.innerHTML = `
            <i class="fas ${icons[type]}"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(msg);
        
        setTimeout(() => {
            msg.style.opacity = '0';
            msg.style.transition = 'opacity 0.3s ease-out';
            setTimeout(() => msg.remove(), 300);
        }, 2700);
    }

});
</script>

{% endblock %}