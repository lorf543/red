{% load static %}
{% load poll_extras %}
<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Title dinámico -->
    <title>{% block title %}ITLAsocial - Red Social ITLA{% endblock %}</title>

    <!-- SEO Básico -->
    <meta name="description" content="{% block description %}ITLAsocial es una red social para estudiantes del ITLA donde puedes compartir, comentar y conectar con otros.{% endblock %}">
    <meta name="keywords" content="ITLA, red social, estudiantes, República Dominicana, universidad, tecnología">
    <meta name="language" content="es-DO">
    <meta name="geo.placename" content="República Dominicana">
    <meta name="geo.region" content="DO">
    <meta name="author" content="ITLAsocial">
    <meta name="robots" content="index, follow">

    <!-- Canonical URL (dinámico) -->
    <link rel="canonical" href="{% block canonical %}https://itlasocial.org{{ request.path }}{% endblock %}">

    <!-- Open Graph (Facebook, WhatsApp) -->
    <meta property="og:site_name" content="ITLAsocial">
    <meta property="og:title" content="{% block og_title %}ITLAsocial - Red Social para estudiantes del ITLA{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Conéctate con estudiantes del ITLA, comparte publicaciones y descubre novedades.{% endblock %}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:url" content="https://itlasocial.org{{ request.path }}">
    <meta property="og:image" content="{% block og_image %}https://itlasocial.org{% static 'img/preview.png' %}{% endblock %}">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="es_DO">

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}ITLAsocial - Red Social para estudiantes del ITLA{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}Conéctate con estudiantes del ITLA, comparte publicaciones y descubre novedades.{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}https://itlasocial.org{% static 'img/preview.png' %}{% endblock %}">
    <meta name="twitter:site" content="@itlasocial">
    <meta name="twitter:creator" content="@itlasocial">

    <!-- Favicon -->
    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">
    <link rel="apple-touch-icon" href="{% static 'img/apple-touch-icon.png' %}">



    <!-- CSS Preload (solo esenciales, los demás cargar normal) -->
    <link rel="stylesheet" href="{% static 'css/themes_raw.css' %}">
    <link rel="stylesheet" href="{% static 'css/table_css.css' %}">
    <link rel="stylesheet" href="{% static 'css/output.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">


    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--color-primary)',
                        secondary: 'var(--color-secondary)',
                        accent: 'var(--color-accent)',
                        background: 'var(--color-background)',
                        text: 'var(--color-text)',
                        surface: 'var(--color-surface)',
                        'surface-dark': 'var(--color-surface-dark)',
                        muted: 'var(--color-muted)',
                        success: 'var(--color-success)',
                        warning: 'var(--color-warning)',
                        danger: 'var(--color-danger)',
                        info: 'var(--color-info)',
                    },
                    fontFamily: {
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Theme Initializer (debe ejecutarse ANTES que el DOM cargue) -->
    <script>
        (function() {
            const theme = localStorage.getItem("theme");
            if (theme && theme !== "default") {
                document.documentElement.setAttribute("data-theme", theme);
            }
            
            // Dark mode support
            const darkMode = localStorage.getItem("darkMode");
            if (darkMode === "true" || (!darkMode && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <!-- Structured Data JSON-LD -->
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "name": "ITLAsocial",
            "url": "https://itlasocial.org/",
            "description": "Red social exclusiva para estudiantes del Instituto Tecnológico de Las Américas (ITLA)",
            "publisher": {
                "@type": "Organization",
                "name": "ITLAsocial",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://itlasocial.org{% static 'img/logo.png' %}"
                }
            },
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://itlasocial.org/search?q={search_term_string}",
                "query-input": "required name=search_term_string"
            },
            "inLanguage": "es-DO"
        }
    </script>

    {% block schema_extra %}{% endblock %}
</head>

<body  class="font-sans"
   >

    <!-- Navbar -->
        {% include "includes/navbar.html" %}


    <!-- Main Content -->
    <main id="main-content" class="min-h-screen">
        {% if messages %}
            <div id="django-messages" class="container mx-auto px-4 py-4 space-y-2">
                {% for message in messages %}
                <div class="alert p-4 rounded-lg text-white shadow-lg animate-fadeIn
                    {% if message.tags == 'success' %}bg-success
                    {% elif message.tags == 'error' %}bg-danger
                    {% elif message.tags == 'warning' %}bg-warning
                    {% elif message.tags == 'info' %}bg-info
                    {% else %}bg-gray-600{% endif %}">
                    <div class="flex items-center justify-between">
                        <span>{{ message }}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 hover:opacity-70">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        <div id="app-shell">
            {% block content %}{% endblock %}
        </div>
    </main>




    <!-- ===================== JS LIBRARIES ===================== -->
    <script src="{% static 'js/htmx.min.js' %}" defer></script>
    <script>
        if (document.querySelector('[x-data]')) {
            const s = document.createElement('script');
            s.src = 'https://unpkg.com/alpinejs';
            s.defer = true;
            document.body.appendChild(s);
        }
    </script>


    

    <script>
        // ---------------------- CSRF para HTMX ----------------------
        document.body.addEventListener('htmx:configRequest', (event) => {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (csrfToken) {
                event.detail.headers['X-CSRFToken'] = csrfToken;
            }
        });

        // ---------------------- Auto-hide Messages ----------------------
        function autoHideMessages() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.transition = 'opacity 0.5s ease-out';
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 500);
                }, 5000);
            });
        }

        // Ejecutar al cargar
        document.addEventListener('DOMContentLoaded', autoHideMessages);

        // Ejecutar después de cada actualización HTMX
        document.body.addEventListener('htmx:afterSwap', autoHideMessages);

        // ---------------------- Responder comentarios ----------------------
        function toggleReplyForm(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            if (form) {
                form.classList.toggle('hidden');
                if (!form.classList.contains('hidden')) {
                    setTimeout(() => {
                        const textarea = form.querySelector('textarea');
                        if (textarea) textarea.focus();
                    }, 100);
                }
            }
        }

        // ---------------------- Reacciones a comentarios ----------------------
        async function reactToComment(commentId, reactionType) {
            try {
                const response = await fetch(`{% url 'react_to_comment' 0 %}`.replace('0', commentId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({
                        reaction_type: reactionType
                    })
                });

                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }

                const data = await response.json();
                
                // Actualizar la UI
                const container = document.querySelector(`.reaction-container[data-comment-id="${commentId}"]`);
                if (container) {
                    const likeCount = container.querySelector('.like-count');
                    const dislikeCount = container.querySelector('.dislike-count');
                    
                    if (likeCount) likeCount.textContent = data.likes_count;
                    if (dislikeCount) dislikeCount.textContent = data.dislikes_count;
                    
                    // Actualizar estilos de botones
                    const likeBtn = container.querySelector('.like-btn i');
                    const dislikeBtn = container.querySelector('.dislike-btn i');
                    
                    if (likeBtn) {
                        likeBtn.className = data.user_reaction === 1 
                            ? 'fas fa-thumbs-up text-primary' 
                            : 'far fa-thumbs-up';
                    }
                    
                    if (dislikeBtn) {
                        dislikeBtn.className = data.user_reaction === -1 
                            ? 'fas fa-thumbs-down text-danger' 
                            : 'far fa-thumbs-down';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('No se pudo registrar tu reacción. Intenta nuevamente.', 'error');
            }
        }

        // ---------------------- Toast Notifications ----------------------
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 p-4 rounded-lg text-white shadow-lg z-50 animate-slideIn ${
                type === 'success' ? 'bg-success' :
                type === 'error' ? 'bg-danger' :
                type === 'warning' ? 'bg-warning' :
                'bg-info'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transition = 'opacity 0.3s ease-out';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

    </script>


</body>
</html>