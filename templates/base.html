{% load static %}
{% load poll_extras %}
<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% if request.user %}
            ITLAsocial | {{ request.user }}
        {% else %}
            ITLAsocial
        {% endif %}
    </title>

    <!-- SEO Básico -->
    <meta name="description" content="ITLAsocial es una red social para estudiantes del ITLA donde puedes compartir, comentar y conectar con otros.">
    <meta name="language" content="es-DO">
    <meta name="geo.placename" content="República Dominicana">
    <meta name="geo.region" content="DO">
    <meta name="author" content="lorf543">
    <meta name="date" content="2025-08-05">
    <meta name="lastmod" content="2025-08-22">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://itlasocial.org/">

    <!-- Open Graph (Facebook, WhatsApp) -->
    <meta property="og:site_name" content="ITLAsocial">
    <meta property="og:title" content="ITLAsocial - Red Social para estudiantes del ITLA">
    <meta property="og:description" content="Conéctate con estudiantes del ITLA, comparte publicaciones y descubre novedades.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://itlasocial.org/">
    <meta property="og:image" content="https://itlasocial.org/static/img/preview.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ITLAsocial - Red Social para estudiantes del ITLA">
    <meta name="twitter:description" content="Conéctate con estudiantes del ITLA, comparte publicaciones y descubre novedades.">
    <meta name="twitter:image" content="https://itlasocial.org/static/img/preview.png">
    <meta name="twitter:site" content="@itlasocial">

    <!--  FAVICON  -->
    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">

    <!--  CSS CRÍTICO  -->
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        }
        nav {
            min-height: 64px;
        }
    </style>


        <!-- CSS PRELOAD  -->
    {% comment %} <link rel="preload" href="{% static 'css/output.css' %}" as="style" onload="this.rel='stylesheet'"> {% endcomment %}
    
    <link rel="preload" href="{% static 'css/themes.css' %}" as="style" onload="this.rel='stylesheet'">
    <link rel="preload" href="{% static 'css/table_css.css' %}" as="style" onload="this.rel='stylesheet'">

    <link rel="preload"
          href="https://cdn.jsdelivr.net/npm/daisyui@5"
          as="style"
          onload="this.rel='stylesheet'">

    <link rel="preload"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
          as="style"
          onload="this.rel='stylesheet'">

    <!-- Fallback -->
    <noscript>
        {% comment %} <link rel="stylesheet" href="{% static 'css/output.css' %}"> {% endcomment %}
        <link rel="stylesheet" href="{% static 'css/themes.css' %}">
        <link rel="stylesheet" href="{% static 'css/table_css.css' %}">
    </noscript>

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>



    <!--  THEME INIT -->
        <script>
            tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                colors: {
                    primary: 'var(--color-primary)',
                    secondary: 'var(--color-secondary)',
                    accent: 'var(--color-accent)',
                    background: 'var(--color-background)',
                    text: 'var(--color-text)',
                    surface: 'var(--color-surface)',
                    muted: 'var(--color-muted)',
                    success: 'var(--color-success)',
                    warning: 'var(--color-warning)',
                    danger: 'var(--color-danger)',
                    info: 'var(--color-info)',
                }
                }
            }
            }
        </script>
    <script defer>
        (function () {
            const theme = localStorage.getItem("theme");
            if (theme && theme !== "default") {
                document.documentElement.setAttribute("data-theme", theme);
            }
        })();
    </script>

    <!-- Datos estructurados JSON-LD -->
    {% comment %} <script type="application/ld+json">
        {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "ITLAsocial",
        "url": "https://itlasocial.org/",
        "description": "Red social para estudiantes del ITLA.",
        "publisher": {
            "@type": "Organization",
            "name": "ITLAsocial"
        }
        }
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CMM8QWLH0R"></script>
    <script defer>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-CMM8QWLH0R');
    </script> {% endcomment %}
</head>

<body  class="font-sans"
   >

    <!-- Navbar -->
        {% include "includes/navbar.html" %}


    <!-- Main Content -->
     <main id="main-content">

        {% if messages %}
        <div class="space-y-2 mb-4">
            {% for message in messages %}
            <div id="message"
                 class="alert p-4 text-white
                        {% if message.tags == 'success' %}alert-success
                        {% elif message.tags == 'error' %}alert-error
                        {% else %}bg-gray-600{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>




    <!-- ===================== JS LIBRARIES ===================== -->
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.6/dist/htmx.min.js" defer></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.12" defer></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script>
        if (document.querySelector('[x-data]')) {
            const s = document.createElement('script');
            s.src = 'https://unpkg.com/alpinejs';
            s.defer = true;
            document.body.appendChild(s);
        }
    </script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js" defer></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js" defer></script>

    

<script defer>

        document.addEventListener('DOMContentLoaded', function() {
    const notificationSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/notifications/'
    );
    
    notificationSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'unread_count' || data.type === 'new_notification') {
            // Actualizar contador
            const badge = document.getElementById('notification-badge');
            const countSpan = document.getElementById('notification-count');
            
            if (data.count === 0) {
                badge.style.display = 'none';
            } else {
                badge.style.display = 'flex';
                countSpan.textContent = data.count;
            }
            
            // Si necesitas Alpine.js
            if (typeof Alpine !== 'undefined') {
                Alpine.store('notifications', { count: data.count });
            }
            
            // Mostrar notificación toast si es nueva
            if (data.type === 'new_notification' && data.notification) {
                showNotificationToast(data.notification);
            }
        }
    };
    
    notificationSocket.onclose = function(e) {
        console.log('WebSocket cerrado. Reconectando...');
        setTimeout(function() {
            // Aquí podrías reconectar si quieres
        }, 1000);
    };
    
    function showNotificationToast(notification) {
        // Crea un toast simple
        const toast = document.createElement('div');
        toast.className = 'toast toast-top toast-end';
        toast.innerHTML = `
            <div class="alert alert-info">
                <span>${notification.actor} ${notification.verb}</span>
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.remove(), 5000);
    }
});
       
    // ---------------------- CSRF para HTMX ----------------------
    document.body.addEventListener('htmx:configRequest', (event) => {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        event.detail.headers['X-CSRFToken'] = csrfToken;
    });

    // ---------------------- Menciones ----------------------
    let mentionMode = false;
    let selectedMentionIndex = 0;

    document.addEventListener('DOMContentLoaded', function() {
        document.body.addEventListener('click', function(e) {
            if (e.target.closest('.mention-user')) {
                e.preventDefault();
                const username = e.target.closest('.mention-user').getAttribute('data-username');
                insertMention(username);
            }
        });
    });

    function insertMention(username) {
        const textarea = document.getElementById('commentTextarea');
        const mentionsContainer = document.getElementById('mentionsContainer');
        if (!textarea || !mentionsContainer) return;

        // Reemplazar @ parcial con mención completa
        textarea.value = textarea.value.replace(/@\w*$/, '@' + username + ' ');
        mentionsContainer.innerHTML = '';
        mentionMode = false;
        selectedMentionIndex = 0;
        
        // Focus y mover cursor al final
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        
        // Auto-resize si existe la función
        if (typeof autoResize === 'function') {
            autoResize(textarea);
        }
    }

    function handleTextareaKeydown(event) {
        const textarea = event.target;
        const mentionsContainer = document.getElementById('mentionsContainer');
        const mentions = mentionsContainer.querySelectorAll('.mention-user');

        // Si hay menciones visibles
        if (mentionMode && mentions.length > 0) {
            // Navegación con flechas
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                selectedMentionIndex = (selectedMentionIndex + 1) % mentions.length;
                updateMentionSelection(mentions);
                return;
            }
            
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                selectedMentionIndex = (selectedMentionIndex - 1 + mentions.length) % mentions.length;
                updateMentionSelection(mentions);
                return;
            }
            
            // Seleccionar con Enter
            if (event.key === 'Enter') {
                event.preventDefault();
                const selectedUser = mentions[selectedMentionIndex];
                if (selectedUser) {
                    insertMention(selectedUser.getAttribute('data-username'));
                }
                return;
            }
        }

        // Cerrar con Escape o Backspace
        if ((event.key === 'Backspace' || event.key === 'Delete') && !textarea.value.match(/@\w*$/)) {
            mentionsContainer.innerHTML = '';
            mentionMode = false;
            selectedMentionIndex = 0;
        }

        if (event.key === 'Escape') {
            mentionsContainer.innerHTML = '';
            mentionMode = false;
            selectedMentionIndex = 0;
        }
    }

    function updateMentionSelection(mentions) {
        mentions.forEach((mention, index) => {
            if (index === selectedMentionIndex) {
                mention.classList.add('bg-primary/15');
                mention.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            } else {
                mention.classList.remove('bg-primary/15');
            }
        });
    }

    function checkMentionMode(event) {
        const textarea = event.target;
        const match = textarea.value.match(/@\w*$/);

        if (match) {
            if (!mentionMode) {
                mentionMode = true;
                selectedMentionIndex = 0;
            }
            textarea.dispatchEvent(new CustomEvent('mention-trigger', { bubbles: true }));
        } else {
            mentionMode = false;
            selectedMentionIndex = 0;
            document.getElementById('mentionsContainer').innerHTML = '';
        }
    }

    // ---------------------- Mensajes (auto ocultar) ----------------------
    function autoHideMessages() {
        const messages = document.querySelectorAll('#message');
        if (messages.length > 0) {
            setTimeout(function() {
                messages.forEach(function(msg) {
                    msg.style.display = 'none';
                });
            }, 7000);
        }
    }

    // Ejecutar al cargar
    document.addEventListener('DOMContentLoaded', autoHideMessages);

    // Ejecutar después de cada actualización HTMX
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        autoHideMessages();
    });


    // ---------------------- Responder comentarios ----------------------
    function toggleReplyForm(commentId) {
        const form = document.getElementById(`reply-form-${commentId}`);
        if (form) {
            form.classList.toggle('hidden');
            if (!form.classList.contains('hidden')) {
                setTimeout(() => {
                    const textarea = form.querySelector('textarea');
                    if (textarea) textarea.focus();
                }, 100);
            }
        }
    }


    // ---------------------- Reacciones a comentarios ----------------------
    async function reactToComment(commentId, reactionType) {
        try {
            const response = await fetch(`{% url 'react_to_comment' 0 %}`.replace('0', commentId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    reaction_type: reactionType
                })
            });

            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }

            const data = await response.json();  // ¡Faltaba esta línea crítica!
            
            // Actualizar la UI
            const container = document.querySelector(`.reaction-container[data-comment-id="${commentId}"]`);
            if (container) {
                const likeCount = container.querySelector('.like-count');
                const dislikeCount = container.querySelector('.dislike-count');
                
                if (likeCount) likeCount.textContent = data.likes_count;
                if (dislikeCount) dislikeCount.textContent = data.dislikes_count;
                
                // Actualizar estilos de botones
                const likeBtn = container.querySelector('.like-btn i');
                const dislikeBtn = container.querySelector('.dislike-btn i');
                
                likeBtn.className = data.user_reaction === 1 
                    ? 'fas fa-thumbs-up text-blue-500' 
                    : 'far fa-thumbs-up';
                    
                dislikeBtn.className = data.user_reaction === -1 
                    ? 'fas fa-thumbs-down text-blue-500' 
                    : 'far fa-thumbs-down';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('No se pudo registrar tu reacción. Intenta nuevamente.');
        }
    }

</script>


</body>
</html>