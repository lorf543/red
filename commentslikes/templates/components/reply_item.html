{% load poll_extras %}

<div class="rounded-lg p-3 mb-3 ml-4 border-l-4 border-primary bg-surface text-text transition-colors duration-300" id="comment-{{ comment.id }}">
    <div class="flex items-start gap-3">
        <!-- Avatar -->
        {% if comment.user.profile.profile_picture %}
            <img src="{{ comment.user.profile.profile_picture.url }}" 
                 alt="{{ comment.user.username }}" 
                 class="w-8 h-8 sm:w-10 sm:h-10 object-cover rounded-full border-2 border-surface">
        {% else %}
            <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-primary text-primary-content flex items-center justify-center font-medium text-sm border-2 border-surface">
                {{ comment.user.profile.get_profile_initials }}
            </div>
        {% endif %}

        <div class="flex-1 min-w-0">
            <!-- Header: Username & Date -->
            <div class="flex items-center justify-between gap-2 mb-1">
                <div class="flex items-center gap-2 min-w-0">
                    <a href="{% url 'profile' comment.user.id %}" 
                       class="font-medium text-sm text-primary hover:text-primary-dark truncate">
                        {{ comment.user.username }}
                    </a>
                    <span class="text-muted text-xs whitespace-nowrap">{{ comment.created_at|timesince }}</span>
                </div>
                <!-- Acciones delete-update -->
                {% include "partials/delete_update_buttons.html" with comment=comment %}
            </div>

            <!-- Moderation Controls -->
            {% if user.is_staff %}
            <div class="flex items-center gap-2 mb-2">
                <button hx-post="{% url 'toggle_moderate' comment.id %}"
                        hx-target="#moderation-status-{{ comment.id }}"
                        class="text-xs px-2 py-1 rounded transition-colors
                               {% if comment.is_active %}bg-warning/10 text-warning hover:bg-warning/20
                               {% else %}bg-success/10 text-success hover:bg-success/20{% endif %}">
                    {% if comment.is_active %}
                        <i class="fas fa-eye-slash mr-1"></i> Ocultar
                    {% else %}
                        <i class="fas fa-eye mr-1"></i> Mostrar
                    {% endif %}
                </button>
                <span id="moderation-status-{{ comment.id }}" class="text-muted text-xs italic">
                    {% if not comment.is_active %}(Moderado por {{ comment.moderated_by.username }}){% endif %}
                </span>
            </div>
            {% endif %}

            <!-- Content -->
            {% if not comment.is_active %}
                <div class="bg-warning/10 text-warning text-xs px-2 py-1 rounded inline-flex items-center gap-1 mb-2">
                    <i class="fas fa-ban"></i>
                    <span>Comentario moderado</span>
                </div>
            {% else %}
                <p class="text-text text-sm leading-relaxed whitespace-pre-wrap break-words">
                    {{ comment.content|censurar|highlight_mentions|linebreaksbr|safe  }}
                </p>
                <div class="mt-1">
                    <a href="{% url 'politicas' %}" 
                       class="text-xs text-muted hover:text-primary transition-colors">
                        Pol√≠ticas sobre comentarios
                    </a>
                </div>
            {% endif %}

            <!-- Reaction Buttons -->
            <div class="mt-3">
                {% include "partials/reaction_buttons.html" with comment=comment likes_count=comment.likes_count dislikes_count=comment.dislikes_count user_reaction=comment.user_reaction %}
            </div>
        </div>
    </div>
</div>