{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <!-- Header Section -->
    <div class="bg-surface rounded-2xl shadow-lg p-6 border border-border">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <h1 class="text-2xl font-bold text-text-primary">Materias por Maestro:</h1>
                    <span class="text-2xl text-primary">{{ teacher }}</span>
                </div>
                <p class="text-text-secondary">Relación completa de materias impartidas por cada docente</p>
                
                <!-- Vote Buttons -->
                <div id="vote-buttons-{{ teacher.id }}" class="mt-4">
                    {% include "teachers/partials/vote_buttons.html" with teacher=teacher positive_votes=positive_votes negative_votes=negative_votes current_vote=current_vote %}
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3">
                <a href="{% url 'teachers_list' %}" 
                   class="inline-flex items-center justify-center gap-2 bg-primary hover:bg-primary-dark text-text-on-primary px-5 py-2.5 rounded-lg transition-colors">
                    <i class="fas fa-arrow-left"></i>
                    Volver a Maestros
                </a>
                <a href="{% url 'assign_subject' teacher.slug %}"
                   class="inline-flex items-center justify-center gap-2 bg-secondary hover:bg-secondary-dark text-text-on-secondary px-5 py-2.5 rounded-lg transition-colors">
                    <i class="fas fa-plus"></i>
                    Asignar Materia
                </a>
            </div>
        </div>
    </div>

    <!-- Subjects Table Section -->
    <div class="bg-surface rounded-2xl shadow-lg overflow-hidden border border-border">
        <div class="overflow-x-auto">
            <table id="materiasTable" class="min-w-full divide-y divide-border">
                <thead class="bg-background">
                    <tr>
                        <th scope="col" class="px-6 py-4 text-left text-sm font-semibold text-text-primary uppercase tracking-wider">
                            Materia
                        </th>
                        <th scope="col" class="px-6 py-4 text-left text-sm font-semibold text-text-primary uppercase tracking-wider">
                            Modalidad
                        </th>
                        <th scope="col" class="px-6 py-4 text-left text-sm font-semibold text-text-primary uppercase tracking-wider">
                            Horario
                        </th>
                        <th scope="col" class="px-6 py-4 text-left text-sm font-semibold text-text-primary uppercase tracking-wider">
                            Estado
                        </th>
                    </tr>
                </thead>
                <tbody id="subject-list" class="divide-y divide-border">
                    {% for subject in subjects %}
                    <tr class="hover:bg-background-hover transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-text-primary">{{ subject.name }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center gap-2">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
                                    <span class="text-sm font-medium text-primary">{{ subject.modalidad|slice:"1" }}</span>
                                </div>
                                <span class="text-sm text-text-primary">{{ subject.modalidad }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-text-primary">{{ subject.subject_schedule }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <!-- Estado placeholder - puedes personalizar esto -->
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success/10 text-success">
                                Activo
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-text-secondary">
                            <div class="flex flex-col items-center justify-center gap-2">
                                <i class="fas fa-book-open text-3xl text-text-disabled"></i>
                                <p>No hay materias asignadas aún</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="bg-surface rounded-2xl shadow-lg overflow-hidden border border-border">
        <!-- Comments Header -->
        <div class="px-6 py-4 border-b border-border">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-text-primary">Comentarios sobre {{ teacher.full_name }}</h2>
                    <p class="text-text-secondary mt-1">Opiniones y evaluaciones de la comunidad</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-text-secondary">
                        {{ comments|length }} comentario{{ comments|length|pluralize }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Comment Form (Authenticated Users) -->
        {% if request.user.is_authenticated %}
        <div class="p-6 border-b border-border">
            <form id="commentForm"
                  method="post"
                  hx-post="{% url 'create_teacher_comment' teacher.id %}"
                  hx-target="#commentsContainer"
                  hx-swap="afterbegin"
                  _="on htmx:afterRequest reset() me"
                  class="space-y-4">
                {% csrf_token %}
                
                <div class="relative">
                    <textarea name="content"
                            id="teacherCommentTextarea"
                            rows="3"
                            class="w-full px-4 py-3 bg-background border border-border rounded-lg text-text-primary placeholder:text-text-disabled focus:ring-2 focus:ring-primary focus:border-transparent resize-none transition-all"
                            placeholder="¿Qué estás pensando sobre este maestro? ¡Comparte tu experiencia!"
                            required
                            oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"></textarea>
                    

                </div>

                <!-- Image Upload Preview -->
                <div id="teacherImagePreviewContainer" class="hidden">
                    <div class="relative inline-block">
                        <img id="teacherImagePreview" class="max-h-48 rounded-lg border border-border">
                        <button type="button"
                                onclick="removeTeacherImage()"
                                class="absolute -top-2 -right-2 w-6 h-6 bg-error text-text-on-error rounded-full flex items-center justify-center hover:bg-error-dark transition-colors">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex items-center justify-between pt-2">
                    <div class="flex items-center gap-2">
                        <!-- File Upload -->
                        <label class="cursor-pointer p-2 text-text-secondary hover:text-primary transition-colors">
                            <i class="fas fa-image text-lg"></i>
                            <input type="file"
                                   id="teacherImageInput"
                                   name="image"
                                   accept="image/*"
                                   class="hidden"
                                   onchange="handleTeacherFileSelect(this)">
                        </label>
                        
                        <!-- Emoji Picker -->
                        <button type="button"
                                onclick="toggleTeacherEmojiPicker(this)"
                                class="p-2 text-text-secondary hover:text-primary transition-colors">
                            <i class="fas fa-smile text-lg"></i>
                        </button>
                    </div>
                    
                    <button type="submit"
                            class="px-6 py-2.5 bg-primary hover:bg-primary-dark text-text-on-primary font-medium rounded-lg transition-colors">
                        Publicar comentario
                    </button>
                </div>
            </form>
            
            <!-- Emoji Picker Popover -->
            <div id="emojiPickerPopover" 
                 class="absolute z-50 hidden bg-surface border border-border rounded-lg shadow-xl">
                <emoji-picker></emoji-picker>
            </div>
        </div>
        {% endif %}

        <!-- Comments Container -->
        <div id="commentsContainer" class="divide-y divide-border">
            {% for comment in comments %}
                {% include "components/comment_item.html" with comment=comment %}
            {% empty %}
                <div class="p-8 text-center">
                    <div class="flex flex-col items-center justify-center gap-3 text-text-disabled">
                        <i class="fas fa-comments text-4xl"></i>
                        <p class="text-lg font-medium">No hay comentarios aún</p>
                        <p class="text-sm">Sé el primero en compartir tu experiencia</p>
                        {% if not request.user.is_authenticated %}
                        <a href="{% url 'login' %}"
                           class="mt-2 inline-flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary-dark text-text-on-primary rounded-lg transition-colors">
                            <i class="fas fa-sign-in-alt"></i>
                            Inicia sesión para comentar
                        </a>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
// Auto-resize textarea
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('teacherCommentTextarea');
    if (textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }
});

// Image handling functions
function handleTeacherFileSelect(input) {
    if (input.files && input.files[0]) {
        showTeacherPreview(input.files[0]);
    }
}

function showTeacherPreview(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('teacherImagePreview');
        const container = document.getElementById('teacherImagePreviewContainer');
        preview.src = e.target.result;
        container.classList.remove('hidden');
    }
    reader.readAsDataURL(file);
}

function removeTeacherImage() {
    const input = document.getElementById('teacherImageInput');
    const preview = document.getElementById('teacherImagePreview');
    const container = document.getElementById('teacherImagePreviewContainer');
    
    if (input) input.value = '';
    if (preview) preview.src = '';
    if (container) container.classList.add('hidden');
}

// Emoji picker functions
function toggleTeacherEmojiPicker(btn) {
    const pickerPopover = document.getElementById('emojiPickerPopover');
    const picker = document.querySelector('emoji-picker');
    const textarea = document.getElementById('teacherCommentTextarea');

    if (!pickerPopover || !picker) return;

    // Toggle visibility
    const isVisible = pickerPopover.classList.contains('hidden');
    pickerPopover.classList.toggle('hidden', !isVisible);
    
    if (isVisible) {
        // Position the picker
        const rect = btn.getBoundingClientRect();
        pickerPopover.style.top = `${window.scrollY + rect.bottom + 5}px`;
        pickerPopover.style.left = `${window.scrollX + rect.left}px`;
        
        // Set up emoji insertion
        const insertEmoji = (event) => {
            if (textarea) {
                const emoji = event.detail.unicode;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                
                textarea.value = text.slice(0, start) + emoji + text.slice(end);
                textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
                textarea.focus();
                textarea.dispatchEvent(new Event('input'));
                
                // Hide picker
                pickerPopover.classList.add('hidden');
                document.removeEventListener('click', outsideClickListener);
            }
        };

        picker.addEventListener('emoji-click', insertEmoji);
        
        // Close when clicking outside
        const outsideClickListener = (e) => {
            if (!pickerPopover.contains(e.target) && e.target !== btn) {
                pickerPopover.classList.add('hidden');
                picker.removeEventListener('emoji-click', insertEmoji);
                document.removeEventListener('click', outsideClickListener);
            }
        };
        
        setTimeout(() => {
            document.addEventListener('click', outsideClickListener);
        }, 0);
    }
}

// Handle paste for images
document.addEventListener('paste', function(e) {
    const textarea = document.getElementById('teacherCommentTextarea');
    if (textarea && document.activeElement === textarea) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                const blob = item.getAsFile();
                if (blob) {
                    // Assign to hidden input
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(blob);
                    const input = document.getElementById('teacherImageInput');
                    if (input) {
                        input.files = dataTransfer.files;
                        showTeacherPreview(blob);
                    }
                    e.preventDefault();
                    break;
                }
            }
        }
    }
});
</script>

<style>
    /* Custom scrollbar for comments */
    #commentsContainer::-webkit-scrollbar {
        width: 6px;
    }

    #commentsContainer::-webkit-scrollbar-track {
        background: transparent;
    }

    #commentsContainer::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
    }

    #commentsContainer::-webkit-scrollbar-thumb:hover {
        background: var(--text-disabled);
    }

    /* Smooth transitions */
    textarea, input, button, a {
        transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 200ms;
    }

    /* Modal animations */
    @keyframes modal-open {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-box {
        animation: modal-open 0.3s ease-out;
    }
</style>
{% endblock %}