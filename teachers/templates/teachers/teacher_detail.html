{% extends "base.html" %}
{% load static %}


{% block content %}

<style>
        /* Estilos para los selects y inputs */
    select, input {
        transition: all 0.2s;
    }

    select:focus, input:focus {
        ring: 2px;
        ring-color: #6366f1;
        border-color: #6366f1;
    }

    /* Estilos para los errores */
    .errorlist {
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #dc2626;
    }

    /* Animación para el modal */
    .modal-box {
        animation: modal-open 0.3s ease-out;
    }

    @keyframes modal-open {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
}
</style>

<div class="max-w-7xl mx-auto px-4 py-8">



    <!-- Encabezado -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8">
            <div class="mb-4 md:mb-0">
                <div class="flex items-center space-x-2">
                    <h1 class="text-2xl font-bold text-text">Materias por Maestro :</h1>
                    <p class="text-xl text-text">{{ teacher }}</p>
                </div>
                <div id="vote-buttons-{{ teacher.id }}">
                    {% include "teachers/partials/vote_buttons.html" with teacher=teacher positive_votes=positive_votes negative_votes=negative_votes current_vote=current_vote %}
                </div>

                <p class="text-text">Relación completa de materias impartidas por cada docente</p>
            </div>
        <div class="flex flex-col md:flex-row space-x-0 md:space-x-3">
            {% comment %} hx-boost="true" {% endcomment %}
            <a  href="{% url 'teachers_list' %}" class="bg-primary hover:bg-secondary text-text px-4 py-2 rounded-lg flex items-center mb-2 md:mb-0">
                <i class="fas fa-arrow-left mr-2 text-text"></i> Volver a Maestros
            </a>
            <a href="{% url 'assign_subject' teacher.slug %}" class="cursor-pointer bg-primary text-text hover:bg-secondary text-text px-4 py-2 rounded-lg flex items-center">
                <i class="fas fa-plus mr-2 text-text"></i> Asignar Materia
            </a>

        </div>
    </div>
    <!-- Tarjeta contenedora -->
    <div class="bg-background shadow-lg rounded-xl overflow-hidden border border-gray-100">

        <!-- Tabla responsive -->
        <div class="overflow-x-auto">
            <table id="materiasTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-background">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text uppercase tracking-wider">Materia</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text uppercase tracking-wider">Modalidad</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text uppercase tracking-wider">Horario</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text uppercase tracking-wider">Estado</th>

                    </tr>
                </thead>
                <tbody id="subject-list" class="bg-background divide-y divide-gray-200">
                    <!-- Ejemplo de fila (reemplazar con tus variables) -->
                    {% for subject in subjects %}
                        <tr class="hover:bg-background transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div>
                                    <div class="text-sm font-medium text-text">{{subject.name}}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-background flex items-center justify-center text-text text-xs font-bold mr-2">
                                    <div class="text-sm text-text">{{subject.modalidad|slice:"1"}}</div>
                                </div>
                                <div class="text-sm text-text">{{subject.modalidad}}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-text">{{subject.subject_schedule}}</div>
                        </td>
                        {% comment %} <td class="px-6 py-4 whitespace-nowrap">
                                <a hx-boost="false" href="{% url 'delete_subject' subject.id %}">Delete</a>
                        </td> {% endcomment %}
                    </tr>
                    
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
        <!-- Sección de Comentarios -->
        <div class="mt-12 bg-background shadow-lg rounded-xl overflow-hidden border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-text">Comentarios sobre {{ teacher.full_name }}</h2>
                <p class="text-text">Opiniones y evaluaciones de la comunidad</p>
            </div>


            <!-- Formulario para crear comentarios -->
            {% if request.user.is_authenticated %}
            <div class="px-4 py-2">
                <div class="bg-background rounded-lg shadow p-4 mb-6">
                    <form id="commentForm"
                        method="post"
                        hx-post="{% url 'create_teacher_comment' teacher.id %}"
                        hx-target="#commentsContainer"
                        hx-swap="afterbegin"
                        _="on htmx:afterRequest reset() me">
                        {% csrf_token %}
                        <textarea name="content" 
                                class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="¿Qué estás pensando?"
                                required></textarea>
                        <div class="flex justify-end mt-3">
                            <button type="submit" 
                                    class="cursor-pointer bg-background text-text px-4 py-2 rounded-lg hover:bg-blue-700">
                                Publicar
                            </button>
                        </div>
                    </form>
                </div>
            {% endif %}
            <!-- Contenedor para los comentarios -->
            <div id="commentsContainer" class="space-y-4">
                {% for comment in comments %}
                    {% include "components/comment_item.html" %}
                {% endfor %}
            </div>
            


        </div>


    
</div>
    



<script>
    
// Funciones para mostrar/ocultar formularios de respuesta
function showReplyForm(commentId) {
    document.getElementById(`reply-form-${commentId}`).classList.remove('hidden');
}

function hideReplyForm(commentId) {
    document.getElementById(`reply-form-${commentId}`).classList.add('hidden');
}

// Scroll a un comentario si hay un hash en la URL
document.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash) {
        const element = document.querySelector(window.location.hash);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth' });
        }
    }
});



    // Manejar el éxito del formulario
    document.body.addEventListener('refreshSubjects', function() {
        // Cierra el modal
        document.getElementById('assign_subject_modal').close();
        
        // Recarga la lista de materias (implementa esto según tu estructura)
        htmx.trigger('#subjects-container', 'refresh');
        
        // Muestra notificación de éxito
        showNotification('Materia asignada correctamente', 'success');
    });
    
    // Función para mostrar notificaciones (puedes usar tu sistema actual)
    function showNotification(message, type) {
        // Implementa tu sistema de notificaciones aquí
        alert(message); // Ejemplo básico
    }


    <
    // 1. Manejo de Archivos (Selección manual)
    function handleTeacherFileSelect(input) {
        if (input.files && input.files[0]) {
            showTeacherPreview(input.files[0]);
        }
    }

    // 2. Manejo de Copy-Paste
    function handleTeacherPaste(e) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let index in items) {
            const item = items[index];
            if (item.kind === 'file' && item.type.includes('image/')) {
                const blob = item.getAsFile();
                
                // Asignar al input hidden
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(blob);
                document.getElementById('teacherImageInput').files = dataTransfer.files;
                
                showTeacherPreview(blob);
            }
        }
    }

    // Mostrar Preview
    function showTeacherPreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('teacherImagePreview').src = e.target.result;
            document.getElementById('teacherImagePreviewContainer').classList.remove('hidden');
        }
        reader.readAsDataURL(file);
    }

    // Quitar Imagen
    function removeTeacherImage() {
        document.getElementById('teacherImageInput').value = '';
        document.getElementById('teacherImagePreview').src = '';
        document.getElementById('teacherImagePreviewContainer').classList.add('hidden');
    }

    // Resetear formulario (HTMX callback)
    function resetTeacherForm() {
        const textarea = document.getElementById('teacherCommentTextarea');
        textarea.style.height = 'auto';
        removeTeacherImage();
    }

    // 3. Lógica de Emojis para este formulario
    function toggleTeacherEmojiPicker(btn) {
        const pickerPopover = document.getElementById('emojiPickerPopover');
        const picker = document.querySelector('emoji-picker');
        const textarea = document.getElementById('teacherCommentTextarea');

        if (!pickerPopover || !picker) return;

        // Posicionamiento
        const rect = btn.getBoundingClientRect();
        pickerPopover.style.top = (window.scrollY + rect.top + 40) + 'px';
        pickerPopover.style.left = (window.scrollX + rect.left) + 'px';
        
        pickerPopover.classList.toggle('active');

        // Listener único para este textarea
        // Usamos una propiedad temporal para evitar listeners duplicados si ya existen
        picker.onclick = function(event) {
             // Esta función se sobrescribe cada vez que abres un picker diferente
             // Asegurando que el emoji vaya al textarea correcto
        }
        
        // Forma robusta de manejar el evento custom del web component
        const insertEmoji = (event) => {
            const emoji = event.detail.unicode;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.slice(0, start) + emoji + text.slice(end);
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
            textarea.focus();
            textarea.dispatchEvent(new Event('input')); // Para el auto-resize
            
            pickerPopover.classList.remove('active');
            
            // Importante: remover el listener para no duplicar en otros formularios
            picker.removeEventListener('emoji-click', insertEmoji);
        };

        picker.addEventListener('emoji-click', insertEmoji, { once: true });
        
        // Cerrar al hacer click fuera
        const closeListener = (e) => {
            if (!pickerPopover.contains(e.target) && e.target !== btn) {
                pickerPopover.classList.remove('active');
                picker.removeEventListener('emoji-click', insertEmoji); // Limpieza
                document.removeEventListener('click', closeListener);
            }
        };
        setTimeout(() => document.addEventListener('click', closeListener), 0);
    }

</script>
{% endblock %}