{% extends "base.html" %}
{% load static %}

<!-- SEO: Title -->
{% block title %}
{{ teacher.full_name }} - Materias, Opiniones y Valoraciones | ITLAsocial
{% endblock %}

<!-- SEO: Description -->
{% block description %}
Perfil de {{ teacher.full_name }}, profesor del Instituto Tecnológico de Las Américas (ITLA). 
Consulta {{ subjects|length }} materia{{ subjects|length|pluralize }} asignada{{ subjects|length|pluralize }}, 
lee {{ comments|length }} comentario{{ comments|length|pluralize }} 
{% if teacher.average_rating %}y su calificación promedio de {{ teacher.average_rating|floatformat:1 }}/5{% endif %}.
{% endblock %}

<!-- SEO: Canonical -->
{% block canonical %}
https://itlasocial.org{{ request.path }}
{% endblock %}

<!-- Open Graph -->
{% block og_title %}
{{ teacher.full_name }} - Opiniones y Materias | ITLAsocial
{% endblock %}

{% block og_description %}
Descubre las materias impartidas por {{ teacher.full_name }} en el ITLA y conoce las experiencias de estudiantes.
{% if teacher.average_rating %}Calificación promedio: {{ teacher.average_rating|floatformat:1 }}/5.{% endif %}
{% endblock %}

{% block og_type %}profile{% endblock %}

{% block og_image %}
https://itlasocial.org{% static 'img/preview.png' %}
{% endblock %}

<!-- Twitter -->
{% block twitter_title %}
{{ teacher.full_name }} - Profesor ITLA | ITLAsocial
{% endblock %}

{% block twitter_description %}
Consulta materias, valoraciones y comentarios sobre {{ teacher.full_name }} en ITLAsocial.
{% endblock %}

{% block twitter_image %}
https://itlasocial.org{% static 'img/preview.png' %}
{% endblock %}

{% block extra_head %}
<meta name="keywords" content="ITLA, {{ teacher.full_name }}, profesor ITLA, materias ITLA, opiniones profesor, valoraciones docentes, Instituto Tecnológico de Las Américas">
<meta property="og:locale" content="es_DO">
<meta property="profile:first_name" content="{{ teacher.full_name }}">
<meta property="profile:username" content="{{ teacher.slug }}">
{% endblock %}
{% block schema_extra %}
<!-- Person Schema -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Person",
    "name": "{{ teacher.full_name|escapejs }}",
    "jobTitle": "Profesor",
    "worksFor": {
        "@type": "EducationalOrganization",
        "name": "Instituto Tecnológico de Las Américas",
        "url": "https://www.itla.edu.do/"
    },
    "url": "https://itlasocial.org{{ request.path }}",
    "description": "Perfil académico de {{ teacher.full_name|escapejs }} en ITLAsocial.",
    {% if teacher.average_rating and comments|length > 0 %}
    "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "{{ teacher.average_rating|floatformat:1 }}",
        "reviewCount": "{{ comments|length }}",
        "bestRating": "5",
        "worstRating": "1"
    },
    {% endif %}
    {% if subjects %}
    "knowsAbout": [
        {% for subject in subjects %}
        "{{ subject.name|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    {% endif %}
    "memberOf": {
        "@type": "EducationalOrganization",
        "name": "Instituto Tecnológico de Las Américas",
        "sameAs": "https://www.itla.edu.do/"
    }
}
</script>

<!-- Breadcrumb Schema -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {
            "@type": "ListItem",
            "position": 1,
            "name": "Inicio",
            "item": "https://itlasocial.org/"
        },
        {
            "@type": "ListItem",
            "position": 2,
            "name": "Maestros",
            "item": "https://itlasocial.org/teachers/"
        },
        {
            "@type": "ListItem",
            "position": 3,
            "name": "{{ teacher.full_name|escapejs }}",
            "item": "https://itlasocial.org{{ request.path }}"
        }
    ]
}
</script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-3 sm:px-4 py-6 sm:py-8 space-y-6 sm:space-y-8">
    <!-- Header Section - Responsive -->
    <div class="bg-surface rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 border border-border">
        <div class="flex flex-col gap-4">
            <div>
                <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 mb-3">
                    <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-text-primary">Materias por Maestro:</h1>
                    <span class="text-lg sm:text-xl md:text-2xl text-primary break-words">{{ teacher }}</span>
                </div>
                <p class="text-sm sm:text-base text-text-secondary">Relación completa de materias impartidas por cada docente</p>
                
                <!-- Vote Buttons - Centrado y responsive -->
                <div id="vote-buttons-{{ teacher.id }}" class="mt-3 sm:mt-4">
                    {% include "teachers/partials/vote_buttons.html" with teacher=teacher positive_votes=positive_votes negative_votes=negative_votes current_vote=current_vote %}
                </div>
            </div>
            
            <!-- Botones de acción - Stack en móvil -->
            <div class="flex flex-col xs:flex-row gap-2 sm:gap-3 pt-2">
                <a href="{% url 'teachers_list' %}" 
                   class="inline-flex items-center justify-center gap-2 bg-primary hover:bg-primary-dark text-text-on-primary px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg transition-colors text-sm sm:text-base">
                    <i class="fas fa-arrow-left text-sm"></i>
                    <span>Volver a Maestros</span>
                </a>
                <a href="{% url 'assign_subject' teacher.slug %}"
                   class="inline-flex items-center justify-center gap-2 bg-secondary hover:bg-secondary-dark text-text-on-secondary px-4 py-2 sm:px-5 sm:py-2.5 rounded-lg transition-colors text-sm sm:text-base">
                    <i class="fas fa-plus text-sm"></i>
                    <span>Asignar Materia</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Subjects Table Section - Scroll horizontal en móvil -->
    <div class="bg-surface rounded-xl sm:rounded-2xl shadow-lg overflow-hidden border border-border">
        <div class="overflow-x-auto -mx-3 sm:mx-0">
            <div class="min-w-full inline-block align-middle">
                <table id="materiasTable" class="min-w-full divide-y divide-border">
                    <thead class="bg-background">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs sm:text-sm font-semibold text-text-primary uppercase tracking-wider whitespace-nowrap">
                                Materia
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs sm:text-sm font-semibold text-text-primary uppercase tracking-wider whitespace-nowrap">
                                Modalidad
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs sm:text-sm font-semibold text-text-primary uppercase tracking-wider whitespace-nowrap">
                                Horario
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs sm:text-sm font-semibold text-text-primary uppercase tracking-wider whitespace-nowrap">
                                Estado
                            </th>
                        </tr>
                    </thead>
                    <tbody id="subject-list" class="divide-y divide-border">
                        {% for subject in subjects %}
                        <tr class="hover:bg-background-hover transition-colors duration-150">
                            <td class="px-4 py-3">
                                <div class="text-sm font-medium text-text-primary">{{ subject.name }}</div>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <div class="flex-shrink-0 w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-primary/10 flex items-center justify-center">
                                        <span class="text-xs sm:text-sm font-medium text-primary">{{ subject.modalidad|slice:"1" }}</span>
                                    </div>
                                    <span class="text-xs sm:text-sm text-text-primary truncate max-w-[80px] sm:max-w-none">{{ subject.modalidad }}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-xs sm:text-sm text-text-primary">{{ subject.subject_schedule }}</div>
                            </td>
                            <td class="px-4 py-3">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-success/10 text-success">
                                    Activo
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-4 py-6 sm:px-6 sm:py-8 text-center text-text-secondary">
                                <div class="flex flex-col items-center justify-center gap-2">
                                    <i class="fas fa-book-open text-2xl sm:text-3xl text-text-disabled"></i>
                                    <p class="text-sm sm:text-base">No hay materias asignadas aún</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="bg-surface rounded-xl sm:rounded-2xl shadow-lg overflow-hidden border border-border">
        <!-- Comments Header -->
        <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-border">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                <div>
                    <h2 class="text-lg sm:text-xl font-bold text-text-primary">Comentarios sobre {{ teacher.full_name }}</h2>
                    <p class="text-xs sm:text-sm text-text-secondary mt-1">Opiniones y evaluaciones de la comunidad</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs sm:text-sm text-text-secondary">
                        {{ comments|length }} comentario{{ comments|length|pluralize }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Comment Form (Authenticated Users) -->
        {% if request.user.is_authenticated %}
        <div class="p-4 sm:p-6 border-b border-border">
            <form id="commentForm"
                method="post"
                hx-post="{% url 'create_teacher_comment' teacher.id %}"
                hx-target="#commentsContainer"
                hx-swap="afterbegin"
                hx-on::after-request="handleCommentSubmit(event)"
                class="space-y-3 sm:space-y-4">
                {% csrf_token %}
                
                <div class="relative">
                    <textarea name="content"
                            id="teacherCommentTextarea"
                            rows="2"
                            class="w-full px-3 py-2 sm:px-4 sm:py-3 bg-background border border-border rounded-lg text-sm sm:text-base text-text-primary placeholder:text-text-disabled focus:ring-2 focus:ring-primary focus:border-transparent resize-none transition-all"
                            placeholder="¿Qué estás pensando sobre este maestro? ¡Comparte tu experiencia!"
                            required
                            oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"></textarea>
                </div>

                <!-- Image Upload Preview -->
                <div id="teacherImagePreviewContainer" class="hidden">
                        <div class="relative inline-block">
                            <img id="teacherImagePreview" loading="lazy" class="max-h-32 sm:max-h-48 rounded-lg border border-border">
                            <button type="button"
                                    onclick="removeTeacherImage()"
                                    class="absolute -top-2 -right-2 w-5 h-5 sm:w-6 sm:h-6 bg-error text-text-on-error rounded-full flex items-center justify-center hover:bg-error-dark transition-colors">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                    </div>

                <!-- Form Actions -->
                <div class="flex items-center justify-between pt-1 sm:pt-2">
                    <div class="flex items-center gap-1 sm:gap-2">
                        <!-- File Upload -->
                        <label class="cursor-pointer p-1.5 sm:p-2 text-text-secondary hover:text-primary transition-colors">
                            <i class="fas fa-image text-base sm:text-lg"></i>
                            <input type="file"
                                id="teacherImageInput"
                                name="image"
                                accept="image/*"
                                class="hidden"
                                onchange="handleTeacherFileSelect(this)">
                        </label>
                        
                        <!-- Emoji Picker -->
                        <button type="button"
                                onclick="toggleTeacherEmojiPicker(this)"
                                class="p-1.5 sm:p-2 text-text-secondary hover:text-primary transition-colors">
                            <i class="fas fa-smile text-base sm:text-lg"></i>
                        </button>
                    </div>
                    
                    <button type="submit"
                            class="px-4 py-2 sm:px-6 sm:py-2.5 bg-primary hover:bg-primary-dark text-text-on-primary text-sm sm:text-base font-medium rounded-lg transition-colors">
                        Publicar comentario
                    </button>
                </div>
            </form>

        </div>
        {% endif %}

        <!-- Comments Container -->
        <div id="commentsContainer" class="divide-y divide-border">
            {% for comment in comments %}
                {% include "components/comment_item.html" with comment=comment %}
            {% empty %}
                <div class="p-6 sm:p-8 text-center">
                    <div class="flex flex-col items-center justify-center gap-2 sm:gap-3 text-text-disabled">
                        <i class="fas fa-comments text-3xl sm:text-4xl"></i>
                        <p class="text-base sm:text-lg font-medium">No hay comentarios aún</p>
                        <p class="text-xs sm:text-sm">Sé el primero en compartir tu experiencia</p>
                        {% if not request.user.is_authenticated %}
                        <a href="{% url 'login' %}"
                           class="mt-2 inline-flex items-center gap-2 px-3 py-1.5 sm:px-4 sm:py-2 bg-primary hover:bg-primary-dark text-text-on-primary text-sm sm:text-base rounded-lg transition-colors">
                            <i class="fas fa-sign-in-alt"></i>
                            Inicia sesión para comentar
                        </a>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
// Auto-resize textarea
function handleCommentSubmit(event) {
    // Solo resetear si la solicitud fue exitosa (código 200-299)
    if (event.detail.successful) {
        const form = document.getElementById('commentForm');
        const textarea = document.getElementById('teacherCommentTextarea');
        
        // Resetear el formulario
        form.reset();
        
        // Limpiar la imagen preview
        removeTeacherImage();
        
        // Resetear el tamaño del textarea
        if (textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        
        // Opcional: Mostrar mensaje de éxito
        // console.log('Comentario publicado exitosamente');
    }
}

// Auto-resize textarea
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('teacherCommentTextarea');
    if (textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }
});

// Image handling functions
function handleTeacherFileSelect(input) {
    if (input.files && input.files[0]) {
        showTeacherPreview(input.files[0]);
    }
}

function showTeacherPreview(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('teacherImagePreview');
        const container = document.getElementById('teacherImagePreviewContainer');
        preview.src = e.target.result;
        container.classList.remove('hidden');
    }
    reader.readAsDataURL(file);
}

function removeTeacherImage() {
    const input = document.getElementById('teacherImageInput');
    const preview = document.getElementById('teacherImagePreview');
    const container = document.getElementById('teacherImagePreviewContainer');
    
    if (input) input.value = '';
    if (preview) preview.src = '';
    if (container) container.classList.add('hidden');
}

// Emoji picker functions
function toggleTeacherEmojiPicker(btn) {
    const pickerPopover = document.getElementById('emojiPickerPopover');
    const picker = document.querySelector('emoji-picker');
    const textarea = document.getElementById('teacherCommentTextarea');

    if (!pickerPopover || !picker) return;

    // Toggle visibility
    const isVisible = pickerPopover.classList.contains('hidden');
    pickerPopover.classList.toggle('hidden', !isVisible);
    
    if (isVisible) {
        // Position the picker
        const rect = btn.getBoundingClientRect();
        pickerPopover.style.top = `${window.scrollY + rect.bottom + 5}px`;
        pickerPopover.style.left = `${window.scrollX + rect.left}px`;
        
        // Set up emoji insertion
        const insertEmoji = (event) => {
            if (textarea) {
                const emoji = event.detail.unicode;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                
                textarea.value = text.slice(0, start) + emoji + text.slice(end);
                textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
                textarea.focus();
                textarea.dispatchEvent(new Event('input'));
                
                // Hide picker
                pickerPopover.classList.add('hidden');
                document.removeEventListener('click', outsideClickListener);
            }
        };

        picker.addEventListener('emoji-click', insertEmoji);
        
        // Close when clicking outside
        const outsideClickListener = (e) => {
            if (!pickerPopover.contains(e.target) && e.target !== btn) {
                pickerPopover.classList.add('hidden');
                picker.removeEventListener('emoji-click', insertEmoji);
                document.removeEventListener('click', outsideClickListener);
            }
        };
        
        setTimeout(() => {
            document.addEventListener('click', outsideClickListener);
        }, 0);
    }
}

// Handle paste for images
document.addEventListener('paste', function(e) {
    const textarea = document.getElementById('teacherCommentTextarea');
    if (textarea && document.activeElement === textarea) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                const blob = item.getAsFile();
                if (blob) {
                    // Assign to hidden input
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(blob);
                    const input = document.getElementById('teacherImageInput');
                    if (input) {
                        input.files = dataTransfer.files;
                        showTeacherPreview(blob);
                    }
                    e.preventDefault();
                    break;
                }
            }
        }
    }
});
</script>

<style>
    /* Custom scrollbar for comments */
    #commentsContainer::-webkit-scrollbar {
        width: 6px;
    }

    #commentsContainer::-webkit-scrollbar-track {
        background: transparent;
    }

    #commentsContainer::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
    }

    #commentsContainer::-webkit-scrollbar-thumb:hover {
        background: var(--text-disabled);
    }

    /* Smooth transitions */
    textarea, input, button, a {
        transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 200ms;
    }

    /* Modal animations */
    @keyframes modal-open {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-box {
        animation: modal-open 0.3s ease-out;
    }
</style>
{% endblock %}